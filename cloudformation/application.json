{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Parameters":{
      "vpccidrblock":{
         "Description":"cidrBlock for VPC",
         "Type":"String"
      },
      "subnetcidrblock":{
         "Description":"cidrBlock for subnet",
         "Type":"String"
      },
      "AWSRegion":{
         "Description":"AWS Region for the stack",
         "Type":"String"
      },
      "VPCName":{
         "Description":"VPC Name",
         "Type":"String"
      },
      "internetGateway":{
         "Description":"Internet Gateway",
         "Type":"String",
         "Default":"myInternetGateway"
      },
      "routeTable":{
         "Description":"Route Table",
         "Type":"String",
         "Default":"myRouteTable"
      },
      "subnet1":{
         "Description":"Subnet for VPC",
         "Type":"String",
         "Default":"mySubnet1"
      },
      "subnet2":{
         "Description":"Subnet for VPC",
         "Type":"String",
         "Default":"mySubnet2"
      },
      "subnet3":{
         "Description":"Subnet for VPC",
         "Type":"String",
         "Default":"mySubnet3"
      },
      "AMI":{
         "Description":"AMI ID/Name for EC2",
         "Type":"String"
      },
      "keyname":{
         "Description":"KeyName for the EC2",
         "Type":"String"
      },
      "ec2InstanceType":{
         "Description":"InstanceType for EC2",
         "Type":"String",
         "Default":"t2.micro"
      },
      "myEC2Name":{
         "Description":"EC2 Name",
         "Type":"String",
         "Default":"myEC2Server"
      },
      "dbSecurityGroup":{
         "Description":"Database Security Group Name",
         "Type":"String",
         "Default":"csye6225-database-securitygroup"
      },
      "appSecurityGroup":{
         "Description":"Application Security Group Name",
         "Type":"String",
         "Default":"csye6225-application-securitygroup"
      },
      "dbName":{
         "Description":"RDS Database Name",
         "Type":"String",
         "Default":"csye6225"
      },
      "dbUserName":{
         "Description":"RDS DB User Name",
         "Type":"String",
         "Default":"dbuser"
      },
      "dbuserPassword":{
         "Description":"RDS DB UserPassword",
         "Type":"String",
         "Default":"dbuserPassword"
      },
      "dbIdentifier":{
         "Description":"RDS Name Identifier",
         "Type":"String",
         "Default":"csye6225-spring2020"
      },
      "APPNAME":{
         "Default":"csye6225-webapp",
         "Description":"Web Application Name",
         "Type":"String"
      },
      "DEPGROUPNAME":{
         "Default":"csye6225-webapp-deployment",
         "Description":"Code Deploy Group Name",
         "Type":"String"
      },
      "myBucketNameForWebApp":{
         "Default":"codedeploy.sarthakgoel.me",
         "Description":"Bucket name for storing application",
         "Type":"String"
      }
   },
   "Resources":{
      "myVPC":{
         "Type":"AWS::EC2::VPC",
         "Properties":{
            "CidrBlock":{
               "Ref":"vpccidrblock"
            },
            "EnableDnsSupport":"true",
            "EnableDnsHostnames":"true",
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Ref":"VPCName"
                  }
               }
            ]
         }
      },
      "myPublicSubnet1":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Fn::Select":[
                  0,
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWSRegion"
                     }
                  }
               ]
            },
            "VpcId":{
               "Ref":"myVPC"
            },
            "CidrBlock":{
               "Fn::Select":[
                  0,
                  {
                     "Fn::Cidr":[
                        {
                           "Ref":"subnetcidrblock"
                        },
                        3,
                        14
                     ]
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"subnet1"
                           },
                           {
                              "Ref":"VPCName"
                           },
                           {
                              "Ref":"AWSRegion"
                           }
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "myPublicSubnet2":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Fn::Select":[
                  1,
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWSRegion"
                     }
                  }
               ]
            },
            "VpcId":{
               "Ref":"myVPC"
            },
            "CidrBlock":{
               "Fn::Select":[
                  1,
                  {
                     "Fn::Cidr":[
                        {
                           "Ref":"subnetcidrblock"
                        },
                        3,
                        14
                     ]
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"subnet2"
                           },
                           {
                              "Ref":"VPCName"
                           },
                           {
                              "Ref":"AWSRegion"
                           }
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "myPublicSubnet3":{
         "Type":"AWS::EC2::Subnet",
         "Properties":{
            "AvailabilityZone":{
               "Fn::Select":[
                  2,
                  {
                     "Fn::GetAZs":{
                        "Ref":"AWSRegion"
                     }
                  }
               ]
            },
            "VpcId":{
               "Ref":"myVPC"
            },
            "CidrBlock":{
               "Fn::Select":[
                  2,
                  {
                     "Fn::Cidr":[
                        {
                           "Ref":"subnetcidrblock"
                        },
                        3,
                        14
                     ]
                  }
               ]
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"subnet3"
                           },
                           {
                              "Ref":"VPCName"
                           },
                           {
                              "Ref":"AWSRegion"
                           }
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "myInternetGateway":{
         "Type":"AWS::EC2::InternetGateway",
         "Properties":{
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"internetGateway"
                           },
                           {
                              "Ref":"VPCName"
                           },
                           {
                              "Ref":"AWSRegion"
                           }
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "VPCGatewayAttachment":{
         "Type":"AWS::EC2::VPCGatewayAttachment",
         "Properties":{
            "VpcId":{
               "Ref":"myVPC"
            },
            "InternetGatewayId":{
               "Ref":"myInternetGateway"
            }
         }
      },
      "myRouteTable":{
         "Type":"AWS::EC2::RouteTable",
         "Properties":{
            "VpcId":{
               "Ref":"myVPC"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"routeTable"
                           },
                           {
                              "Ref":"VPCName"
                           },
                           {
                              "Ref":"AWSRegion"
                           }
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "routeTableAssocSubnet1":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"myPublicSubnet1"
            },
            "RouteTableId":{
               "Ref":"myRouteTable"
            }
         }
      },
      "routeTableAssocSubnet2":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"myPublicSubnet2"
            },
            "RouteTableId":{
               "Ref":"myRouteTable"
            }
         }
      },
      "routeTableAssocSubnet3":{
         "Type":"AWS::EC2::SubnetRouteTableAssociation",
         "Properties":{
            "SubnetId":{
               "Ref":"myPublicSubnet3"
            },
            "RouteTableId":{
               "Ref":"myRouteTable"
            }
         }
      },
      "myRouteName":{
         "Type":"AWS::EC2::Route",
         "Properties":{
            "RouteTableId":{
               "Ref":"myRouteTable"
            },
            "DestinationCidrBlock":"0.0.0.0/0",
            "GatewayId":{
               "Ref":"myInternetGateway"
            }
         }
      },
      "applicationSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"Security group for EC2 server",
            "GroupName":"csye6225-securitygroup",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"22",
                  "ToPort":"22",
                  "CidrIp":"0.0.0.0/0"
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"80",
                  "ToPort":"80",
                  "CidrIp":"0.0.0.0/0"
               },
               {
                  "IpProtocol":"tcp",
                  "FromPort":"443",
                  "ToPort":"443",
                  "CidrIp":"0.0.0.0/0"
               },
               {
                  "FromPort":"8080",
                  "IpProtocol":"tcp",
                  "ToPort":"8080",
                  "CidrIp":"0.0.0.0/0"
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Ref":"appSecurityGroup"
                  }
               }
            ],
            "VpcId":{
               "Ref":"myVPC"
            }
         }
      },
      "databaseSecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "GroupDescription":"SecurityGroup for RDS",
            "GroupName":"csye6225-database-securitygroup",
            "SecurityGroupIngress":[
               {
                  "IpProtocol":"tcp",
                  "FromPort":"3306",
                  "ToPort":"3306",
                  "SourceSecurityGroupId":{
                     "Ref":"applicationSecurityGroup"
                  }
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Ref":"dbSecurityGroup"
                  }
               }
            ],
            "VpcId":{
               "Ref":"myVPC"
            }
         }
      },
      "myS3Bucket":{
         "Type":"AWS::S3::Bucket",
         "Properties":{
            "AccessControl":"Private",
            "BucketEncryption":{
               "ServerSideEncryptionConfiguration":[
                  {
                     "ServerSideEncryptionByDefault":{
                        "SSEAlgorithm":"AES256"
                     }
                  }
               ]
            },
            "LifecycleConfiguration":{
               "Rules":[
                  {
                     "Id":"ShiftIn30Days",
                     "Status":"Enabled",
                     "Transition":{
                        "TransitionInDays":"30",
                        "StorageClass":"STANDARD_IA"
                     }
                  }
               ]
            }
         }
      },
      "ElasticLoadBalancer": {
         "Type": "AWS::ElasticLoadBalancingV2::LoadBalancer",
         "Properties": {
            "Name": "csye6225-load-balancer",
            "Scheme": "internet-facing",
            "Type": "application",
            "SecurityGroups": [
               {
                  "Ref": "applicationSecurityGroup"
               }
            ],
            "Subnets": [
               {
                  "Ref":"myPublicSubnet1"
               },
               {
                  "Ref":"myPublicSubnet2"
               },
               {
                  "Ref":"myPublicSubnet3"
               }
            ]
         }
      },
      "ELBListener": {
         "Type": "AWS::ElasticLoadBalancingV2::Listener",
         "Properties": {
            "LoadBalancerArn": {
               "Ref": "ElasticLoadBalancer"
            },
            "DefaultActions": [
               {
                  "Type": "forward",
                  "TargetGroupArn": {
                     "Ref": "ELBTargetGroup"
                  }
               }
            ],
            "Port": "443",
            "Protocol": "HTTPS"
         }
      },
      "ELBTargetGroup": {
         "Type": "AWS::ElasticLoadBalancingV2::TargetGroup",
         "Properties": {
            "HealthCheckIntervalSeconds": 10,
            "HealthCheckTimeoutSeconds": 5,
            "UnhealthyThresholdCount": 2,
            "HealthyThresholdCount": 2,
            "HealthCheckPath": "/health",
            "TargetGroupAttributes": [
               {
                  "Key": "deregistration_delay.timeout_seconds",
                  "Value": "20"
               }
            ],
            "Name": {
               "Fn::Join": [
                  "-",
                  [
                     {
                        "Ref": "AWS::StackName"
                     },
                     "TargetGroup"
                  ]
               ]
            },
            "Port": 80,
            "Protocol": "HTTP",
            "VpcId": {
               "Ref":"myVPC"
            }
         },
         "DependsOn": [
            "ElasticLoadBalancer"
         ]
      },
      "CodeDeployEC2S3":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"CodeDeploy-EC2-S3",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "s3:Get*",
                        "s3:List*"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"myBucketNameForWebApp"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            }
         }
      },
      "AutoScalingEC2Instance": {
         "Type": "AWS::AutoScaling::LaunchConfiguration",
         "DependsOn": [
            "myRDS"
         ],
         "Properties": {
            "ImageId": {
               "Ref":"AMI"
            },
            "InstanceType": "t2.micro",
            "IamInstanceProfile": {
               "Ref":"myEC2InstanceProfile"
            },
            "SecurityGroups": [
               {
                  "Fn::GetAtt": [
                     "applicationSecurityGroup",
                     "GroupId"
                  ]
               }
            ],
            "KeyName": {
               "Ref":"keyname"
            },
            "UserData": {
               "Fn::Base64": {
                  "Fn::Join": [
                     "\n",
                     [
                        "#!/bin/bash -xe",
                        "echo export SPRING_PROFILE=dev>>/etc/profile.d/envvariable.sh",
                        "echo export DB_USERNAME=csye6225master>>/etc/profile.d/envvariable.sh",
                        "echo export DB_PASSWORD=csye6225password>>/etc/profile.d/envvariable.sh",
                        {
                           "Fn::Join": [
                              "",
                              [
                                 "echo export WEBAPP_BUCKETNAME=",
                                 {
                                    "Ref": "myBucketNameForWebApp"
                                 },
                                 ">>/etc/profile.d/envvariable.sh"
                              ]
                           ]
                        },
                        {
                           "Fn::Join": [
                              "",
                              [
                                 "echo export DB_ENDPOINT=",
                                 {
                                    "Fn::GetAtt": [
                                       "myRDS",
                                       "Endpoint.Address"
                                    ]
                                 },
                                 ">>/etc/profile.d/envvariable.sh"
                              ]
                           ]
                        },
                        "chmod 0755 /etc/profile.d/envvariable.sh",
                        "source /etc/profile.d/envvariable.sh",
                        "mkdir /home/ubuntu/webapp",
                        "chown ubuntu:ubuntu -R /home/ubuntu/webapp",
                        "iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination :8080"
                     ]
                  ]
               }
            }
         }
      },
      "WebServerGroup": {
         "Type": "AWS::AutoScaling::AutoScalingGroup",
         "Properties": {
            "AutoScalingGroupName": "csye6225ASG",
            "Cooldown": "60",
            "DesiredCapacity": "3",
            "LaunchConfigurationName": {
               "Ref": "AutoScalingEC2Instance"
            },
            "MaxSize": "10",
            "MinSize": "3",
            "TargetGroupARNs": [
               {
                  "Ref": "ELBTargetGroup"
               }
            ],
            "Tags": [
               {
                  "Key": "Name",
                  "Value": {
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"myEC2Name"
                           },
                           {
                              "Ref":"VPCName"
                           }
                        ]
                     ]
                  },
                  "PropagateAtLaunch": "True"
               }
            ],
            "VPCZoneIdentifier": [
               {
                  "Ref":"myPublicSubnet1"
               },
               {
                  "Ref":"myPublicSubnet2"
               },
               {
                  "Ref":"myPublicSubnet3"
               }
            ]
         }
      },
      "WebServerScaleUpPolicy": {
         "Type": "AWS::AutoScaling::ScalingPolicy",
         "Properties": {
            "AdjustmentType": "ChangeInCapacity",
            "AutoScalingGroupName": {
               "Ref": "WebServerGroup"
            },
            "Cooldown": "10",
            "ScalingAdjustment": "1"
         }
      },
      "WebServerScaleDownPolicy": {
         "Type": "AWS::AutoScaling::ScalingPolicy",
         "Properties": {
            "AdjustmentType": "ChangeInCapacity",
            "AutoScalingGroupName": {
               "Ref": "WebServerGroup"
            },
            "Cooldown": "10",
            "ScalingAdjustment": "-1"
         }
      },
      "AccessAttachmentToS3Bucket":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "ManagedPolicyName":"Access-Attachment-To-S3-Bucket",
            "Description":"Policy for uploading attachments into S3",
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "s3:GetObject",
                        "s3:DeleteObject",
                        "s3:PutObject"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"myS3Bucket"
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "arn:aws:s3:::",
                                 {
                                    "Ref":"myS3Bucket"
                                 },
                                 "/*"
                              ]
                           ]
                        }
                     ]
                  }
               ]
            }
         }
      },
      "circleciec2ami":{
         "Properties":{
            "PolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "ec2:AttachVolume",
                        "ec2:AuthorizeSecurityGroupIngress",
                        "ec2:CopyImage",
                        "ec2:CreateImage",
                        "ec2:CreateKeypair",
                        "ec2:CreateSecurityGroup",
                        "ec2:CreateSnapshot",
                        "ec2:CreateTags",
                        "ec2:CreateVolume",
                        "ec2:DeleteKeyPair",
                        "ec2:DeleteSecurityGroup",
                        "ec2:DeleteSnapshot",
                        "ec2:DeleteVolume",
                        "ec2:DeregisterImage",
                        "ec2:DescribeImageAttribute",
                        "ec2:DescribeImages",
                        "ec2:DescribeInstances",
                        "ec2:DescribeInstanceStatus",
                        "ec2:DescribeRegions",
                        "ec2:DescribeSecurityGroups",
                        "ec2:DescribeSnapshots",
                        "ec2:DescribeSubnets",
                        "ec2:DescribeTags",
                        "ec2:DescribeVolumes",
                        "ec2:DetachVolume",
                        "ec2:GetPasswordData",
                        "ec2:ModifyImageAttribute",
                        "ec2:ModifyInstanceAttribute",
                        "ec2:ModifySnapshotAttribute",
                        "ec2:RegisterImage",
                        "ec2:RunInstances",
                        "ec2:StopInstances",
                        "ec2:TerminateInstances"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ],
               "Version":"2012-10-17"
            },
            "PolicyName":"circleci-ec2-ami",
            "Users":[
               "circleci"
            ]
         },
         "Type":"AWS::IAM::Policy"
      },
      "CirlceCICodeDeploy":{
         "Properties":{
            "PolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "codedeploy:RegisterApplicationRevision",
                        "codedeploy:GetApplicationRevision"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 "application:csye6225-webapp"
                              ]
                           ]
                        }
                     ]
                  },
                  {
                     "Action":[
                        "codedeploy:CreateDeployment",
                        "codedeploy:GetDeployment"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        "*"
                     ]
                  },
                  {
                     "Action":[
                        "codedeploy:GetDeploymentConfig"
                     ],
                     "Effect":"Allow",
                     "Resource":[
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 "deploymentconfig",
                                 "CodeDeployDefault.OneAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 "deploymentconfig",
                                 "CodeDeployDefault.HalfAtATime"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              ":",
                              [
                                 "arn:aws:codedeploy",
                                 {
                                    "Ref":"AWS::Region"
                                 },
                                 {
                                    "Ref":"AWS::AccountId"
                                 },
                                 "deploymentconfig",
                                 "CodeDeployDefault.AllAtOnce"
                              ]
                           ]
                        }
                     ]
                  }
               ],
               "Version":"2012-10-17"
            },
            "PolicyName":"CirlceCI-Code-Deploy",
            "Users":[
               "circleci"
            ]
         },
         "Type":"AWS::IAM::Policy"
      },
      "CirlceCIUploadToS3":{
         "Properties":{
            "PolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "s3:Get*",
                        "s3:List*",
                        "s3:PutObject"
                     ],
                     "Effect":"Allow",
                     "Resource":{
                        "Fn::Join":[
                           "",
                           [
                              "arn:aws:s3:::",
                              {
                                 "Ref":"myBucketNameForWebApp"
                              },
                              "/*"
                           ]
                        ]
                     }
                  }
               ],
               "Version":"2012-10-17"
            },
            "PolicyName":"CirlceCI-Upload-To-S3",
            "Users":[
               "circleci"
            ]
         },
         "Type":"AWS::IAM::Policy"
      },
      "CodeDeployEC2ServiceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "RoleName":"CodeDeployEC2ServiceRole",
            "ManagedPolicyArns":[
               {
                  "Ref":"CodeDeployEC2S3"
               },
               {
                  "Ref":"AccessAttachmentToS3Bucket"
               },
               "arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy"
            ],
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "sts:AssumeRole"
                     ],
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     }
                  }
               ],
            }
         }
      },
      "CodeDeployServiceRole":{
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "sts:AssumeRole"
                     ],
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "codedeploy.amazonaws.com"
                        ]
                     }
                  }
               ],
               "Version":"2012-10-17"
            },
            "ManagedPolicyArns":[
               "arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"
            ],
            "RoleName":"CodeDeployServiceRole"
         },
         "Type":"AWS::IAM::Role"
      },
      "myDBSubnetGroup":{
         "Type":"AWS::RDS::DBSubnetGroup",
         "Properties":{
            "DBSubnetGroupDescription":"DBSubnet Group for RDS",
            "SubnetIds":[
               {
                  "Ref":"myPublicSubnet1"
               },
               {
                  "Ref":"myPublicSubnet2"
               },
               {
                  "Ref":"myPublicSubnet3"
               }
            ]
         }
      },
      "myRDS":{
         "Type":"AWS::RDS::DBInstance",
         "Properties":{
            "Engine":"MySQL",
            "DBInstanceClass":"db.t3.micro",
            "MultiAZ":false,
            "DBInstanceIdentifier":{
               "Ref":"dbIdentifier"
            },
            "MasterUsername":{
               "Ref":"dbUserName"
            },
            "MasterUserPassword":{
               "Ref":"dbuserPassword"
            },
            "PubliclyAccessible":false,
            "DBName":{
               "Ref":"dbName"
            },
            "DBSubnetGroupName":{
               "Ref":"myDBSubnetGroup"
            },
            "VPCSecurityGroups":[
               {
                  "Ref":"databaseSecurityGroup"
               }
            ],
            "AllocatedStorage":"10"
         }
      },
      "myEC2":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "ImageId":{
               "Ref":"AMI"
            },
            "InstanceType":{
               "Ref":"ec2InstanceType"
            },
            "BlockDeviceMappings":[
               {
                  "DeviceName":"/dev/sda1",
                  "Ebs":{
                     "VolumeSize":"20",
                     "VolumeType":"gp2",
                     "DeleteOnTermination":true
                  }
               }
            ],
            "KeyName":{
               "Ref":"keyname"
            },
            "NetworkInterfaces":[
               {
                  "AssociatePublicIpAddress":true,
                  "DeviceIndex":"0",
                  "DeleteOnTermination":true,
                  "SubnetId":{
                     "Ref":"myPublicSubnet3"
                  },
                  "GroupSet":[
                     {
                        "Ref":"applicationSecurityGroup"
                     }
                  ]
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash \n",
                        "set -e -x \n",
                        "sudo systemctl stop tomcat \n",
                        "sudo echo profile=dev >> /etc/profile.d/envvariable.sh \n",
                        "sudo echo export profile >> /etc/profile.d/envvariable.sh \n",
                        "sudo echo DBCreationType=update >> /etc/profile.d/envvariable.sh \n",
                        "sudo echo export DBCreationType >> /etc/profile.d/envvariable.sh \n",
                        {
                           "Fn::Sub":"sudo echo username=${dbUserName} >> /etc/profile.d/envvariable.sh \n"
                        },
                        "sudo echo export username >> /etc/profile.d/envvariable.sh \n",
                        {
                           "Fn::Sub":"sudo echo password=${dbuserPassword} >> /etc/profile.d/envvariable.sh \n"
                        },
                        "sudo echo export password >> /etc/profile.d/envvariable.sh \n",
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "echo awsRDS=jdbc:mysql://",
                                 {
                                    "Fn::GetAtt":[
                                       "myRDS",
                                       "Endpoint.Address"
                                    ]
                                 },
                                 {
                                    "Fn::Sub":":3306/${dbName} >> /etc/profile.d/envvariable.sh \n"
                                 }
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo bucketName=",
                                 {
                                    "Ref":"myS3Bucket"
                                 },
                                 ">> /etc/profile.d/envvariable.sh \n"
                              ]
                           ]
                        },
                        {
                           "Fn::Join":[
                              "",
                              [
                                 "sudo echo rdsEndpoint=",
                                 {
                                    "Fn::GetAtt":[
                                       "myRDS",
                                       "Endpoint.Address"
                                    ]
                                 },
                                 ">> /etc/profile.d/envvariable.sh \n"
                              ]
                           ]
                        },
                        "sudo echo export rdsEndpoint >> /etc/profile.d/envvariable.sh \n",
                        "sudo echo export awsRDS >> /etc/profile.d/envvariable.sh \n",
                        "sudo echo export bucketName >> /etc/profile.d/envvariable.sh \n"
                     ]
                  ]
               }
            },
            "IamInstanceProfile":{
               "Ref":"myEC2InstanceProfile"
            },
            "Tags":[
               {
                  "Key":"Name",
                  "Value":{
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"myEC2Name"
                           },
                           {
                              "Ref":"VPCName"
                           }
                        ]
                     ]
                  }
               }
            ]
         }
      },
      "myEC2InstanceProfile": {
         "Properties": {
            "Path": "/",
            "Roles": [
               {
                  "Ref": "CodeDeployEC2ServiceRole"
               }
            ]
         },
         "Type": "AWS::IAM::InstanceProfile"
      },
      "WebappApplication": {
         "Properties": {
            "ApplicationName": {
               "Ref": "APPNAME"
            },
            "ComputePlatform": "Server"
         },
         "Type": "AWS::CodeDeploy::Application"
      },
      "WebappDeploymentGroup": {
         "DependsOn": "CodeDeployServiceRole",
         "Properties": {
            "ApplicationName": {
               "Ref": "WebappApplication"
            },
            "AutoRollbackConfiguration": {
               "Enabled": "true",
               "Events": [
                  "DEPLOYMENT_FAILURE"
               ]
            },
            "DeploymentConfigName": "CodeDeployDefault.AllAtOnce",
            "AutoScalingGroups": [
               {
                  "Ref": "WebServerGroup"
               }
            ],
            "DeploymentGroupName": {
               "Ref": "DEPGROUPNAME"
            },
            "DeploymentStyle": {
               "DeploymentOption": "WITHOUT_TRAFFIC_CONTROL",
               "DeploymentType": "IN_PLACE"
            },
            "Ec2TagFilters": [
               {
                  "Key": "Name",
                  "Type": "KEY_AND_VALUE",
                  "Value": {
                     "Fn::Join":[
                        "-",
                        [
                           {
                              "Ref":"myEC2Name"
                           },
                           {
                              "Ref":"VPCName"
                           }
                        ]
                     ]
                  }
               }
            ],
            "ServiceRoleArn": {
               "Fn::GetAtt": [
                  "CodeDeployServiceRole",
                  "Arn"
               ]
            }
         },
         "Type": "AWS::CodeDeploy::DeploymentGroup"
      }
   },
   "Outputs":{
      "myVPC":{
         "Description":"VPC Created",
         "Value":{
            "Ref":"myVPC"
         }
      },
      "myPublicSubnet1":{
         "Description":"public Subnet 1 ID",
         "Value":{
            "Ref":"myPublicSubnet1"
         }
      },
      "myPublicSubnet2":{
         "Description":"public Subnet 2 ID",
         "Value":{
            "Ref":"myPublicSubnet2"
         }
      },
      "myPublicSubnet3":{
         "Description":"public Subnet 3 ID",
         "Value":{
            "Ref":"myPublicSubnet3"
         }
      }
   }
}